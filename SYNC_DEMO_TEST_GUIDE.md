# AI助手跨页面同步和模拟对话功能测试指南 🧪

## 新增功能

### 1. 跨页面实时同步 🔄
- **localStorage监听**: 使用`storage`事件监听其他标签页的对话更新
- **自动UI同步**: 当在一个标签页发送消息时，其他打开的页面会实时显示
- **完整历史恢复**: 切换页面时自动加载完整对话历史

### 2. 模拟对话模式 🤖
- **无需API**: 未配置API密钥时自动使用硬编码回答
- **ROS2知识库**: 内置常见ROS2问题的标准答案
- **友好提示**: 提醒用户可配置API获得更智能的回答

---

## 测试步骤

### 测试1: 跨页面实时同步

1. **打开第一个标签页**
   ```
   http://localhost:8080/index.html
   ```
   - 点击🤖 AI助手
   - 发送消息："你好"

2. **打开第二个标签页**（新标签）
   ```
   http://localhost:8080/assets/html/Installation.html
   ```
   - 点击🤖 AI助手
   - **验证**: 应该能看到刚才在第一个标签页发送的"你好"消息和AI回复

3. **在第二个标签页发送消息**
   - 输入："什么是节点？"
   - 点击发送

4. **切换回第一个标签页**
   - **验证**: 应该能看到"什么是节点？"的消息和AI回复
   - 两个标签页的对话历史应该完全一致

5. **打开第三个标签页**
   ```
   http://localhost:8080/assets/html/Tutorials.html
   ```
   - 点击🤖 AI助手
   - **验证**: 应该能看到所有之前的对话历史

### 测试2: 模拟对话功能

**前提**: 不配置API密钥，使用默认状态

1. **打开页面并查看提示**
   ```
   http://localhost:8080/index.html
   ```
   - 点击🤖 AI助手
   - **验证**: 应该看到"💡 当前使用模拟对话模式..."提示

2. **测试ROS2安装问题**
   - 输入："如何安装ros2？"
   - **预期回答**: 详细的安装步骤（包含bash命令）
   - **验证**: 回答末尾有"💡 API未配置，这是模拟回答"提示

3. **测试节点问题**
   - 输入："ros2节点是什么？"
   - **预期回答**: 节点定义和Python示例代码
   - **验证**: 包含代码块和模拟模式提示

4. **测试话题问题**
   - 输入："ros2话题怎么用？"
   - **预期回答**: 话题命令列表（list, pub, echo, info）
   - **验证**: 包含bash命令示例

5. **测试launch问题**
   - 输入："如何写launch文件？"
   - **预期回答**: Python launch文件示例
   - **验证**: 包含完整的代码示例

6. **测试问候语**
   - 输入："你好"
   - **预期回答**: 功能介绍列表和模拟模式提示

7. **测试帮助**
   - 输入："帮助"
   - **预期回答**: 分类的功能说明（基础、开发、进阶）

8. **测试通用问题**
   - 输入："colcon是什么？"（不在预设问题中）
   - **预期回答**: 提示当前为模拟模式，建议配置API或浏览文档

### 测试3: 跨页面同步 + 模拟对话

1. **标签页A**: 发送"如何安装ros2？"
2. **标签页B**: 打开并点击AI助手
   - **验证**: 能看到"如何安装ros2？"及其回答
3. **标签页B**: 发送"什么是节点？"
4. **标签页A**: 
   - **验证**: 能看到"什么是节点？"及其回答
   - **验证**: 对话顺序正确

### 测试4: 刷新页面保持历史

1. 发送多条消息：
   - "你好"
   - "如何安装ros2？"
   - "什么是话题？"

2. **按F5刷新页面**
   - **验证**: 所有对话历史保留
   - **验证**: UI显示正确

3. **关闭标签页再重新打开**
   - 访问 http://localhost:8080/assets/html/Tutorials.html
   - 点击🤖 AI助手
   - **验证**: 历史对话依然存在

---

## 预期行为

### 模拟模式特征
✅ 启动时显示提示信息（非错误）  
✅ 能正常发送和接收消息  
✅ 回答包含代码示例和格式化文本  
✅ 每个回答末尾有模拟模式提示  
✅ 打字动画正常显示（约800ms延迟）  

### 跨页面同步特征
✅ 多个标签页的对话历史完全一致  
✅ 在任意标签页发送消息，其他标签页实时显示  
✅ 页面刷新后历史保留  
✅ 新打开的标签页自动加载历史  

---

## 硬编码问题覆盖

当前支持的关键词触发：

| 关键词 | 触发条件 | 回答内容 |
|--------|----------|----------|
| `安装` / `install` | 包含"ros2"或"ros 2" | 完整安装步骤 |
| `节点` / `node` | 包含"ros2"或"ros 2" | 节点定义+Python示例 |
| `话题` / `topic` | 包含"ros2"或"ros 2" | 话题命令大全 |
| `launch` / `启动` | 包含"ros2"或"ros 2" | Launch文件示例 |
| `你好` / `hello` / `hi` | 任意消息 | 功能介绍 |
| `帮助` / `help` | 任意消息 | 分类功能说明 |
| 其他 | 默认 | 通用提示+示例问题 |

---

## 技术实现细节

### LocalStorage同步机制

```javascript
// 监听其他标签页的更新
window.addEventListener('storage', (e) => {
    if (e.key === 'ros2_chat_history' && e.newValue) {
        this.conversationHistory = JSON.parse(e.newValue);
        this.restoreChatMessages(); // 重新渲染UI
    }
});
```

### 模拟对话判断逻辑

```javascript
async sendMessage() {
    if (!this.apiKey) {
        // 使用硬编码回答
        response = this.getHardcodedResponse(message);
    } else {
        // 调用真实API
        response = await this.callOpenAI();
    }
}
```

### UI同步流程

```
标签页A发送消息
    ↓
localStorage.setItem('ros2_chat_history', ...)
    ↓
触发storage事件
    ↓
标签页B/C/D监听到变化
    ↓
更新conversationHistory
    ↓
调用restoreChatMessages()
    ↓
清空并重新渲染所有消息
    ↓
UI完成同步
```

---

## 常见问题排查

### Q: 其他标签页没有同步显示新消息？
A: 检查：
1. 确认两个标签页是同源（相同域名和端口）
2. 检查浏览器控制台是否有JavaScript错误
3. 验证localStorage中的`ros2_chat_history`是否更新
   ```javascript
   // 在控制台运行
   console.log(localStorage.getItem('ros2_chat_history'));
   ```

### Q: 模拟回答没有显示？
A: 检查：
1. 确认没有配置API密钥（localStorage中`ai_api_key`为空）
2. 查看浏览器控制台是否有错误
3. 验证`getHardcodedResponse()`方法是否正确执行

### Q: 刷新后历史丢失？
A: 检查：
1. 浏览器是否处于隐私/无痕模式（会限制localStorage）
2. localStorage是否被手动清除
3. 运行测试：
   ```javascript
   // 保存测试数据
   localStorage.setItem('test', 'hello');
   // 刷新页面后检查
   console.log(localStorage.getItem('test')); // 应该输出'hello'
   ```

---

## 下一步优化建议

### 可选增强功能
1. **消息时间戳**: 显示每条消息的发送时间
2. **消息计数**: 显示未读消息数量
3. **导出对话**: 允许导出对话历史为文本文件
4. **多会话支持**: 允许创建多个独立的对话会话
5. **搜索历史**: 在历史对话中搜索关键词

### API配置后的测试
1. 配置通义千问API密钥
2. 测试真实API响应
3. 验证API失败时是否正确回退到模拟模式
4. 测试图片上传功能（需视觉模型）

---

**测试完成标准**:
- [ ] 跨页面实时同步正常工作
- [ ] 模拟对话能正确响应所有预设问题
- [ ] 历史记录在刷新后保留
- [ ] 多个标签页对话历史一致
- [ ] 用户界面友好，提示清晰
- [ ] 无JavaScript错误

**更新日期**: 2026年1月13日  
**版本**: 2.1 (跨页面同步 + 模拟对话)
